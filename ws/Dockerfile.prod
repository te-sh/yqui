FROM golang:1.15.8-alpine3.13 AS builder

WORKDIR /app

RUN apk update \
 && apk add git \
 && go get gopkg.in/natefinch/lumberjack.v2 \
 && go get github.com/gorilla/websocket

ADD . ./

RUN go build

FROM alpine:3.13

RUN apk update \
 && apk upgrade \
 && apk add tzdata \
 && cp /usr/share/zoneinfo/Asia/Tokyo /etc/localtime \
 && apk del tzdata \
 && rm -rf /var/cache/apk/* \
 && addgroup -g 1000 -S yqui \
 && adduser -u 1000 -S yqui -G yqui

USER yqui
ENV HOME /home/yqui
ENV APPDIR $HOME/app
RUN mkdir -p $APPDIR

WORKDIR $APPDIR
COPY --from=builder --chown=yqui:yqui /app/app .

ENV YQUI_ENV prod
